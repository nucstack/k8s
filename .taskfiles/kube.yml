---
version: '3'

env:
  KUBECONFIG: "{{.PROJECT_DIR}}/{{.ENVIRONMENT}}.kubeconfig"

tasks:

  kubeconfig:
    desc: fetch kubeconfig from bootstrap k8s master
    cmds:
    - "[ -d ~/.ssh ] || mkdir ~/.ssh && echo -e {{.SSH_PRIVATE_KEY}} > ~/.ssh/id_rsa && chmod 0600 ~/.ssh/id_rsa"
    - rsync --verbose --progress --partial --rsync-path="sudo rsync" {{.SSH_USER}}@{{.K8S_MASTER_IP}}:/etc/kubernetes/admin.conf {{.PROJECT_DIR}}/{{.ENVIRONMENT}}.kubeconfig    
    - sed -i 's/127.0.0.1/{{.K8S_MASTER_IP}}/g' {{.PROJECT_DIR}}/{{.ENVIRONMENT}}.kubeconfig
    - chmod go-r {{.PROJECT_DIR}}/{{.ENVIRONMENT}}.kubeconfig
    silent: true  