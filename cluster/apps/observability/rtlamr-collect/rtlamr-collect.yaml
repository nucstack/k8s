---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: rtlamr-collect
  namespace: observability
  annotations:
    checkov.io/skip1: CKV_K8S_8=TODO
    checkov.io/skip2: CKV_K8S_9=TODO
    checkov.io/skip3: CKV_K8S_15=TODO
    checkov.io/skip4: CKV_K8S_16=TODO
    checkov.io/skip5: CKV_K8S_20=TODO
    checkov.io/skip6: CKV_K8S_22=TODO
    checkov.io/skip7: CKV_K8S_23=TODO
    checkov.io/skip8: CKV_K8S_28=TODO
    checkov.io/skip9: CKV_K8S_29=TODO
    checkov.io/skip10: CKV_K8S_31=TODO
    checkov.io/skip11: CKV_K8S_35=TODO
    checkov.io/skip12: CKV_K8S_37=TODO
    checkov.io/skip13: CKV_K8S_38=TODO
    checkov.io/skip14: CKV_K8S_40=TODO
    checkov.io/skip15: CKV_K8S_43=TODO
  labels:
    app.kubernetes.io/name: rtlamr-collect
    app.kubernetes.io/instance: rtlamr-collect
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/instance: rtlamr-collect
      app.kubernetes.io/name: rtlamr-collect
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app.kubernetes.io/instance: rtlamr-collect
        app.kubernetes.io/name: rtlamr-collect
    spec:
      containers:
        - name: rtlamr-collect
          securityContext:
            privileged: true
          image: ${SECRET_PRIVATE_REGISTRY}/rtlamr-collect:0.0.2
          imagePullPolicy: IfNotPresent
          env:
            - name: INTERVAL
              value: "30"
            - name: COLLECT_LOGLEVEL
              value: "DEBUG"
            - name: RTLAMR_FORMAT
              value: "json"
            - name: RTLAMR_FILTERID
              valueFrom:
                secretKeyRef:
                  name: rtlamr-collect
                  key: meters
            - name: RTLAMR_MSGTYPE
              valueFrom:
                secretKeyRef:
                  name: rtlamr-collect
                  key: msgtype
            - name: COLLECT_INFLUXDB_ORG
              value: "home"
            - name: COLLECT_INFLUXDB_BUCKET
              value: "meters/autogen"
            - name: COLLECT_INFLUXDB_MEASUREMENT
              value: "utilities"
            - name: COLLECT_INFLUXDB_HOSTNAME
              value: "http://influxdb.observability.svc.cluster.local:8086"
            - name: COLLECT_INFLUXDB_TOKEN
              valueFrom:
                secretKeyRef:
                  name: rtlamr-collect
                  key: influxdb-token
          resources:
            limits:
              cpu: 500m
              memory: 128Mi
            requests:
              cpu: 500m
              memory: 128Mi
          volumeMounts:
            - name: usb
              mountPath: /dev/swradio0
      volumes:
        - name: usb
          hostPath:
            path: /dev/swradio0
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
              - matchExpressions:
                  - key: device/0bda_2838
                    operator: In
                    values:
                      - 'true'
