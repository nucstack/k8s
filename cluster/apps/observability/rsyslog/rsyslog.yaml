---
apiVersion: v1
kind: ConfigMap
metadata:
  name: rsyslog-config
  namespace: observability
  labels:
    app.kubernetes.io/name: rsyslog
    app.kubernetes.io/instance: rsyslog
data:
  rsyslog.conf: |
    #$DebugLevel 2
    $ModLoad imudp
    $UDPServerRun 514
    *.* @@(o)loki-promtail-syslog.observability.svc.cluster.local:1514;RSYSLOG_SyslogProtocol23Format
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: rsyslog
  namespace: observability
  annotations:
    checkov.io/skip3: CKV_K8S_8
    checkov.io/skip4: CKV_K8S_9
  labels:
    app.kubernetes.io/name: rsyslog
    app.kubernetes.io/instance: rsyslog
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: rsyslog
      app.kubernetes.io/instance: rsyslog
  replicas: 1
  template:
    metadata:
      labels:
        app.kubernetes.io/name: rsyslog
        app.kubernetes.io/instance: rsyslog
    spec:
      securityContext:
        runAsUser: 10001
        runAsGroup: 10001
      automountServiceAccountToken: false
      containers:
        - name: rsyslog
          securityContext:
            runAsUser: 10001
            runAsGroup: 10001
            capabilities:
              drop:
                - ALL
          image: "${SECRET_PRIVATE_REGISTRY}/rsyslog@sha256:11fd10ff27d9da658e74d174b4b39698a8075a7e5569f8036cc226c6cfff8780"
          imagePullPolicy: "Always"
          ports:
            - name: default
              containerPort: 514
              protocol: UDP
          resources:
            limits:
              cpu: 500m
              memory: 256Mi
            requests:
              cpu: 100m
              memory: 128Mi
          volumeMounts:
            - mountPath: /etc/rsyslog.conf
              readOnly: true
              name: config
              subPath: rsyslog.conf
      volumes:
        - name: config
          configMap:
            name: rsyslog-config
            items:
              - key: rsyslog.conf
                path: rsyslog.conf
---
apiVersion: v1
kind: Service
metadata:
  name: rsyslog
  namespace: observability
  labels:
    app.kubernetes.io/name: rsyslog
    app.kubernetes.io/instance: rsyslog
spec:
  type: LoadBalancer
  externalTrafficPolicy: Cluster
  loadBalancerIP: "${SECRET_RSYSLOG_LB_IP}"
  sessionAffinity: None
  ports:
    - port: 514
      targetPort: default
      protocol: UDP
      name: default
  selector:
    app.kubernetes.io/name: rsyslog
    app.kubernetes.io/instance: rsyslog
