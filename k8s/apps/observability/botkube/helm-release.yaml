---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: botkube
  namespace: observability
spec:
  install:
    timeout: 10m
    remediation: # perform remediation when helm install fails
      retries: 3
  upgrade:
    remediation: # perform remediation when helm upgrade fails
      retries: 3
      remediateLastFailure: true # remediate the last failure, when no retries remain
    cleanupOnFail: true
  rollback:
    timeout: 10m
    recreate: true
    cleanupOnFail: true
  timeout: 20m
  interval: 5m
  chart:
    spec:
      # renovate: registryUrl=https://infracloudio.github.io/charts
      chart: botkube
      version: v0.12.3
      sourceRef:
        kind: HelmRepository
        name: infracloudio-charts
        namespace: flux-system
      interval: 5m
  valuesFrom:
    - kind: Secret
      name: botkube-helm-values
  values:
    resources:
      limits:
        cpu: 100m
        memory: 1Gi
      requests:
        cpu: 50m
        memory: 600Mi
    serviceMonitor:
      enabled: true
      interval: 180s
      path: /metrics
      port: metrics

    rbac:
      create: true
      rules:
        - apiGroups: ["*"]
          resources: ["*"]
          verbs: ["get", "watch", "list"]
    serviceAccount:
      create: true
    config:
      settings:
        clustername: "${ENVIRONMENT}"
        kubectl:
          enabled: "true"
          commands:
            # method which are allowed
            verbs: ["api-resources", "api-versions", "cluster-info", "describe", "diff", "explain", "get", "logs", "top", "auth"]
            # resource configuration which is allowed
            resources: ["jobs", "deployments", "pods", "namespaces", "daemonsets", "statefulsets", "storageclasses", "nodes"]
            # set Namespace to execute BotKube kubectl commands by default
            defaultNamespace: default
            # Set true to enable commands execution from configured channel only
            restrictAccess: true
      resources:
        - name: v1/pods                # Name of the resources e.g pod, deployment, ingress, etc. (Resource name must be in singular form)
          namespaces:
            include:
              - all
            ignore:                 # List of namespaces to be ignored (omitempty), used only with include: all
              - kube-system
              - default
          events:                   # List of lifecycle events you want to receive, e.g create, update, delete, error OR all
            - create
            - delete
        - name: v1/services
          namespaces:
            include:
              - all
          events:
            - create
            - delete
            - error
        - name: apps/v1/deployments
          namespaces:
            include:
              - all
          events:
            - create
            - update
            - delete
            - error
          updateSetting:
            includeDiff: true
            fields:
              - spec.template.spec.containers[*].image
        - name: apps/v1/statefulsets
          namespaces:
            include:
              - all
          events:
            - create
            - update
            - delete
            - error
          updateSetting:
            includeDiff: true
            fields:
              - spec.template.spec.containers[*].image
        - name: networking.k8s.io/v1/ingresses
          namespaces:
            include:
              - all
          events:
            - create
            - delete
            - error
        - name: v1/nodes
          namespaces:
            include:
              - all
          events:
            - create
            - delete
            - error
        - name: v1/namespaces
          namespaces:
            include:
              - all
          events:
            - create
            - delete
            - error
        - name: v1/persistentvolumes
          namespaces:
            include:
              - all
          events:
            - create
            - delete
            - error
        - name: v1/persistentvolumeclaims
          namespaces:
            include:
              - all
          events:
            - create
            - delete
            - error
        - name: v1/secrets
          namespaces:
            include:
              - all
          events:
            - create
            - delete
            - error
        - name: v1/configmaps
          namespaces:
            include:
              - all
          events:
            - delete
            - error
        - name: apps/v1/daemonsets
          namespaces:
            include:
              - all
          events:
            - create
            - delete
            - error
            - update
          updateSetting:
            includeDiff: true
            fields:
              - spec.template.spec.containers[*].image
        - name: batch/v1/jobs
          namespaces:
            include:
              - all
            ignore:
              - kube-system
          events:
            - error
          updateSetting:
            includeDiff: true
            fields:
              - spec.template.spec.containers[*].image
              - status.conditions[*].type
        - name: rbac.authorization.k8s.io/v1/roles
          namespaces:
            include:
              - all
          events:
            - create
            - delete
            - error
        - name: rbac.authorization.k8s.io/v1/rolebindings
          namespaces:
            include:
              - all
          events:
            - create
            - delete
            - error
        - name: rbac.authorization.k8s.io/v1/clusterroles
          namespaces:
            include:
              - all
          events:
            - create
            - delete
            - error
        - name: rbac.authorization.k8s.io/v1/clusterrolebindings
          namespaces:
            include:
              - all
          events:
            - create
            - delete
            - error
        - name: helm.toolkit.fluxcd.io/v2beta1/HelmRelease
          namespaces:
            include:
              - all
            ignore:
              - kube-system
          events:
            - create
            - update
            - delete
            - error
        - name: kustomize.toolkit.fluxcd.io/v1beta1/Kustomization
          namespaces:
            include:
              - all
            ignore:
              - kube-system
          events:
            - create
            - update
            - delete
            - error
        - name: source.toolkit.fluxcd.io/v1beta1/GitRepository
          namespaces:
            include:
              - all
            ignore:
              - kube-system
          events:
            - create
            - update
            - delete
            - error
        - name: acme.cert-manager.io/v1alpha2/Orders
          namespaces:
            include:
              - all
            ignore:
              - kube-system
          events:
            - create
            - update
            - delete
            - error
