---
version: '3'

vars:
  PROJECT_DIR:
    sh: "git rev-parse --show-toplevel"
  CLUSTER_DIR: "{{.PROJECT_DIR}}/cluster"
  TERRAFORM_DIR: "{{.PROJECT_DIR}}/terraform/cluster"
  # the terraform state used to build instances contains some useful things
  SSH_USER:
    sh: "jq '.resources[] | select((.module == \"module.k8s\") and .type == \"proxmox_vm_qemu\") | .instances[0].attributes.ciuser' {{.TERRAFORM_DIR}}/terraform.tfstate"
  SSH_PRIVATE_KEY:
    sh: "jq '.resources[] | select((.module == \"module.k8s\") and .type == \"tls_private_key\") | .instances[0].attributes.private_key_pem' terraform/cluster/terraform.tfstate"
  SSH_PUBLIC_KEY:
    sh: "jq '.resources[] | select((.module == \"module.k8s\") and .type == \"tls_private_key\") | .instances[0].attributes.public_key_openssh' {{.TERRAFORM_DIR}}/terraform.tfstate"
  K8S_MASTER_IP:
    sh: "jq '.resources[] | select((.module == \"module.k8s\") and .type == \"proxmox_vm_qemu\") | .instances[0].attributes.ssh_host' {{.TERRAFORM_DIR}}/terraform.tfstate | tr -d '\"'"

env:
  ENVIRONMENT: '{{.ENVIRONMENT | default "staging"}}'
  KUBECONFIG: "{{.PROJECT_DIR}}/{{.ENVIRONMENT}}.kubeconfig"

dotenv: ["{{.ENVIRONMENT}}.env"]
  
includes:
  ansible: .taskfiles/ansible.yml
  flux: .taskfiles/flux.yml
  kube: .taskfiles/kube.yml